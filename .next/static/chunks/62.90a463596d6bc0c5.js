(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[62],{5062:function(e,t,r){"use strict";r.r(t),r.d(t,{default:function(){return m}});var o=r(7437),n=r(2265),a=r(2520),s=r.n(a);r(4982);class i{set(e,t){if(this.cache.size>=this.maxSize){let e=this.cache.keys().next().value;e&&(this.cache.delete(e),console.log("[Cache] Evicted oldest entry:",e))}this.cache.set(e,{data:t,timestamp:Date.now()})}get(e){let t=this.cache.get(e);return t?Date.now()-t.timestamp>this.ttl?(this.cache.delete(e),console.log("[Cache] Entry expired:",e),null):t.data:null}delete(e){return this.cache.delete(e)}clear(){this.cache.clear(),console.log("[Cache] Cleared all entries")}size(){return this.cache.size}getStats(){return{size:this.cache.size,maxSize:this.maxSize,ttl:this.ttl,entries:Array.from(this.cache.keys())}}constructor(e=50,t=30){this.cache=new Map,this.maxSize=e,this.ttl=6e4*t}}let l=new i(50,30),c=[-114.0719,51.0447],u="properties-light",d="clusters",p="cluster-count",f="unclustered-point";function m(e){let{onPropertySelect:t,selectedPropertyId:r,filters:a,isDarkMode:i}=e,m=(0,n.useRef)(null),h=(0,n.useRef)(null),g=(0,n.useRef)(null),y=(0,n.useRef)(!1),x=(0,n.useRef)(null),b=(0,n.useRef)(!0),v=(0,n.useRef)(!1),w=(0,n.useRef)(null),k=(0,n.useRef)(null),M=(0,n.useRef)(null),R=(0,n.useRef)(i),[C,D]=(0,n.useState)(!1),[T,L]=(0,n.useState)(!0),[E,S]=(0,n.useState)(null),[z,N]=(0,n.useState)(null),[j,_]=(0,n.useState)([]),F=(0,n.useCallback)(e=>{console.log("[Map Diagnostic]",e),_(t=>[...t,"".concat(new Date().toISOString().split("T")[1].slice(0,8),": ").concat(e)])},[]);(0,n.useEffect)(()=>{b.current=T},[T]),(0,n.useEffect)(()=>{v.current=C},[C]);let O=(0,n.useCallback)(async e=>{let t=l.get(e);if(t)return console.log("[Map] Using cached details for",e),t;try{console.log("[Map] Fetching details for",e);let t=await fetch("/api/properties/".concat(e,"/details"));if(!t.ok)throw Error("HTTP ".concat(t.status));let r=await t.json();if(r.success&&r.data)return l.set(e,r.data),r.data;return null}catch(e){return console.error("[Map] Failed to load property details:",e),null}},[]),A=(0,n.useCallback)(async(e,t,r)=>{try{if(!h.current)return;let o=new(s()).Popup({closeButton:!0,closeOnClick:!0,maxWidth:"320px",offset:15}).setLngLat(t).setHTML('\n          <div class="p-4">\n            <h3 class="font-bold text-lg mb-2">'.concat(r.name,'</h3>\n            <div class="animate-pulse">\n              <div class="h-4 bg-gray-200 rounded mb-2"></div>\n              <div class="h-4 bg-gray-200 rounded w-3/4"></div>\n            </div>\n          </div>\n        ')).addTo(h.current);g.current=o;let n=await O(e);if(n&&g.current===o){let t='\n        <div class="p-4 min-w-[280px]">\n          <h3 class="font-bold text-lg mb-2">'.concat(n.fullDetails.name,'</h3>\n          <div class="space-y-2">\n            <div>\n              <span class="inline-block px-2 py-1 text-xs font-semibold rounded ').concat({active:"bg-green-100 text-green-800",pending:"bg-yellow-100 text-yellow-800",in_progress:"bg-blue-100 text-blue-800"}[n.fullDetails.status]||"bg-gray-100",'">\n                ').concat(n.fullDetails.status.toUpperCase(),'\n              </span>\n            </div>\n            <div class="text-sm">\n              <p class="text-gray-600 font-medium">').concat(n.fullDetails.type,"</p>\n              ").concat(n.fullDetails.subType?'<p class="text-gray-500 text-xs">'.concat(n.fullDetails.subType,"</p>"):"",'\n            </div>\n            <div class="text-sm text-gray-700">').concat(n.fullDetails.address,'</div>\n            <div class="text-xs text-gray-600">\n              <p><span class="font-semibold">Community:</span> ').concat(n.fullDetails.community,'</p>\n            </div>\n            <div class="text-xs text-gray-500 pt-2 border-t">\n              <p>Issued: ').concat(new Date(n.fullDetails.issuedDate).toLocaleDateString(),"</p>\n              ").concat(n.fullDetails.expiryDate?"<p>Expires: ".concat(new Date(n.fullDetails.expiryDate).toLocaleDateString(),"</p>"):"","\n            </div>\n            <button \n              onclick=\"window.dispatchEvent(new CustomEvent('property-details-click', { detail: '").concat(e,'\' }))"\n              class="w-full mt-2 px-3 py-2 bg-calgary-blue text-white text-sm font-semibold rounded hover:bg-blue-700 transition"\n            >\n              View Full Details →\n            </button>\n          </div>\n        </div>\n      ');o.setHTML(t)}}catch(e){console.error("[Map] Error showing popup:",e),g.current&&(g.current.remove(),g.current=null)}},[O]);return((0,n.useEffect)(()=>{let e;if(F("Component mounted, starting map init..."),!m.current){F("ERROR: mapContainer ref is null");return}if(h.current){F("Map already exists, skipping init");return}let r=e=>{y.current||(y.current=!0,console.error("[Map] Fatal error:",e),S(e),L(!1))};if(F("Checking WebGL support..."),!s().supported()){F("ERROR: WebGL not supported"),S("WebGL is not supported in this browser/device. The map cannot be displayed."),L(!1);return}F("WebGL is supported ✓");let o="pk.eyJ1Ijoid2VsbHN3ZWxsIiwiYSI6ImNta2twdmY3ZDFoazEzZnBueGtoaHkweWQifQ.xYmDCOqxWs_IDkcSnYchMA";if(!o){F("ERROR: Mapbox token not found in env"),S("Mapbox token not configured"),L(!1);return}F("Mapbox token found: ".concat(o.slice(0,8),"...")),F("Creating Mapbox GL Map instance..."),s().accessToken=o;try{F("Calling new mapboxgl.Map()..."),e=new(s()).Map({container:m.current,style:i?"mapbox://styles/mapbox/dark-v11":"mapbox://styles/mapbox/light-v11",center:c,zoom:11,maxZoom:18,minZoom:9}),F("Map instance created successfully ✓")}catch(e){F("ERROR creating map: ".concat(e.message||e)),r("Failed to create map: ".concat(e.message||e));return}h.current=e,F("Adding map controls..."),e.addControl(new(s()).NavigationControl,"top-right"),e.addControl(new(s()).ScaleControl({unit:"metric"}),"bottom-left"),F("Controls added ✓");let n=m.current;if(n){let t=n.getBoundingClientRect();if(F("Container size: ".concat(Math.round(t.width),"x").concat(Math.round(t.height))),0===t.height){F("⚠️ Container has 0 height! Retrying resize...");let t=()=>{try{let t=n.getBoundingClientRect();F("Retry: Container size now ".concat(Math.round(t.width),"x").concat(Math.round(t.height))),e.resize(),t.height>0&&F("✅ Height fixed! Map resized.")}catch(e){}};setTimeout(t,100),setTimeout(t,300),setTimeout(t,500),setTimeout(t,1e3)}"undefined"!=typeof ResizeObserver&&(w.current=new ResizeObserver(()=>{try{e.resize()}catch(e){}}),w.current.observe(n),F("ResizeObserver attached ✓"))}window.setTimeout(()=>{try{e.resize()}catch(e){}},0);let a=e=>({status:"number"==typeof(null==e?void 0:e.status)?e.status:void 0,url:"string"==typeof(null==e?void 0:e.url)?e.url:void 0,message:e&&"string"==typeof e.message&&e.message||"string"==typeof e&&e||"Mapbox failed to load some resources."});e.on("error",e=>{let t=null==e?void 0:e.error,{status:o,url:n,message:s}=a(t),i="".concat(s).concat(o?" (HTTP ".concat(o,")"):"",".").concat(n?" URL: ".concat(n):"").concat(" If this persists, verify the Mapbox token is valid and not restricted (Allowed URLs should include https://calgary.ypilo.com) and that api.mapbox.com/tiles.mapbox.com are not blocked by adblock/proxy.");console.error("[Map] Mapbox error:",t),N(i),b.current&&r(i)}),x.current=window.setTimeout(()=>{v.current||y.current||r("Map is taking too long to load. This usually means Mapbox requests are blocked (adblock/CSP) or the token is invalid/restricted.")},12e3),e.on("load",async()=>{F('\uD83C\uDF89 map.on("load") fired! Style loaded.'),console.log("[Map] Map loaded, fetching light GeoJSON...");try{e.resize(),F("map.resize() called")}catch(e){}try{F("Fetching /api/properties/light...");let r=await fetch("/api/properties/light");if(!r.ok)throw Error("Failed to load properties: HTTP ".concat(r.status));let o=await r.json();F("Loaded ".concat(o.count," properties ✓")),k.current=o,M.current=o,console.log("[Map] Loaded",o.count,"properties"),F("Adding GeoJSON source to map..."),e.addSource(u,{type:"geojson",data:o,cluster:!0,clusterMaxZoom:14,clusterRadius:50}),F("Source added ✓"),e.addLayer({id:d,type:"circle",source:u,filter:["has","point_count"],paint:{"circle-color":"#0066b3","circle-radius":["step",["get","point_count"],18,100,24,750,30],"circle-opacity":.85,"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),e.addLayer({id:p,type:"symbol",source:u,filter:["has","point_count"],layout:{"text-field":["get","point_count_abbreviated"],"text-font":["DIN Offc Pro Medium","Arial Unicode MS Bold"],"text-size":12},paint:{"text-color":"#ffffff"}}),e.addLayer({id:f,type:"circle",source:u,filter:["!",["has","point_count"]],paint:{"circle-color":["match",["get","status"],"active","#10b981","pending","#f59e0b","in_progress","#3b82f6","#10b981"],"circle-radius":6,"circle-stroke-width":1,"circle-stroke-color":"#ffffff","circle-opacity":.9}}),e.on("click",d,t=>{var r;let o=e.queryRenderedFeatures(t.point,{layers:[d]})[0],n=null==o?void 0:null===(r=o.properties)||void 0===r?void 0:r.cluster_id,a=e.getSource(u);a&&null!=n&&a.getClusterExpansionZoom(n,(t,r)=>{t||e.easeTo({center:o.geometry.coordinates,zoom:r})})}),e.on("click",f,e=>{try{var r;let o=null===(r=e.features)||void 0===r?void 0:r[0];if(!o)return;let n=o.properties,a=o.geometry.coordinates.slice();A(n.id,a,{name:n.name,type:n.type,status:n.status}),t&&t(n.id)}catch(e){console.error("[Map] Error handling point click:",e)}}),e.on("mouseenter",d,()=>{e.getCanvas().style.cursor="pointer"}),e.on("mouseleave",d,()=>{e.getCanvas().style.cursor=""}),e.on("mouseenter",f,()=>{e.getCanvas().style.cursor="pointer"}),e.on("mouseleave",f,()=>{e.getCanvas().style.cursor=""}),F("✅ MAP FULLY LOADED AND READY"),D(!0),L(!1),x.current&&(window.clearTimeout(x.current),x.current=null),window.setTimeout(()=>{try{h.current&&!h.current.areTilesLoaded()&&N("Map tiles are not loading. This usually means Mapbox domains are blocked (adblock/corporate proxy) or the token is restricted. Please allow api.mapbox.com and tiles.mapbox.com.")}catch(e){}},6e3)}catch(e){F("ERROR in map load handler: ".concat(e.message||e)),console.error("[Map] Error loading properties:",e),S(e.message),L(!1),x.current&&(window.clearTimeout(x.current),x.current=null)}}),F('map.on("load") listener registered. Waiting for style to load...');let l=window.setTimeout(()=>{v.current||y.current||(F('⚠️ TIMEOUT: Map did not fire "load" event after 10s'),r("Map initialization timed out. The Mapbox style or tiles may be blocked. Check browser console for details and ensure api.mapbox.com is accessible."))},1e4);return()=>{if(window.clearTimeout(l),x.current&&(window.clearTimeout(x.current),x.current=null),w.current){try{w.current.disconnect()}catch(e){}w.current=null}F("Cleanup: removing map"),e.remove(),h.current=null}},[A,t,F]),(0,n.useEffect)(()=>{if(!h.current||!C||!k.current)return;let e=h.current;(null==a?void 0:a.statuses)&&a.statuses.length>0||(null==a?void 0:a.types)&&a.types.length>0||(null==a?void 0:a.communities)&&a.communities.length>0||(null==a?void 0:a.expiryFilter)&&a.expiryFilter;let t=k.current.features;if((null==a?void 0:a.statuses)&&a.statuses.length>0&&(t=t.filter(e=>a.statuses.includes(e.properties.status))),(null==a?void 0:a.types)&&a.types.length>0&&(t=t.filter(e=>a.types.includes(e.properties.type))),(null==a?void 0:a.communities)&&a.communities.length>0&&(t=t.filter(e=>a.communities.includes(e.properties.community))),(null==a?void 0:a.expiryFilter)&&"all"!==a.expiryFilter){let e=new Date;t=t.filter(t=>{let r=t.properties.expiryDate;if(!r)return!1;let o=(new Date(r).getTime()-e.getTime())/864e5;switch(a.expiryFilter){case"expired":return o<0;case"week":return o>=0&&o<=7;case"month":return o>=0&&o<=30;case"quarter":return o>=0&&o<=90;case"year":return o>=0&&o<=365;default:return!0}})}let r={...k.current,features:t,count:t.length};M.current=r;let o=e.getSource(u);o&&(o.setData(r),console.log("[Map] Filtered to ".concat(t.length," of ").concat(k.current.features.length," properties")))},[a,C]),(0,n.useEffect)(()=>{if(R.current===i||!h.current||!C||!M.current)return;R.current=i;let e=h.current,t=i?"mapbox://styles/mapbox/dark-v11":"mapbox://styles/mapbox/light-v11";e.once("style.load",()=>{console.log("[Map] Style loaded, re-adding sources and layers..."),e.getSource(u)||e.addSource(u,{type:"geojson",data:M.current,cluster:!0,clusterMaxZoom:14,clusterRadius:50}),e.getLayer(d)||e.addLayer({id:d,type:"circle",source:u,filter:["has","point_count"],paint:{"circle-color":"#0066b3","circle-radius":["step",["get","point_count"],18,100,24,750,30],"circle-opacity":.85,"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}),e.getLayer(p)||e.addLayer({id:p,type:"symbol",source:u,filter:["has","point_count"],layout:{"text-field":["get","point_count_abbreviated"],"text-font":["DIN Offc Pro Medium","Arial Unicode MS Bold"],"text-size":12},paint:{"text-color":"#ffffff"}}),e.getLayer(f)||e.addLayer({id:f,type:"circle",source:u,filter:["!",["has","point_count"]],paint:{"circle-color":["match",["get","status"],"active","#10b981","pending","#f59e0b","in_progress","#3b82f6","#10b981"],"circle-radius":6,"circle-stroke-width":1,"circle-stroke-color":"#ffffff","circle-opacity":.9}}),console.log("[Map] Theme switched to",i?"dark":"light")}),e.setStyle(t)},[i,C]),(0,n.useEffect)(()=>{let e=e=>{let r=e.detail;null==t||t(r)};return window.addEventListener("property-details-click",e),()=>{window.removeEventListener("property-details-click",e)}},[t]),E)?(0,o.jsx)("div",{className:"w-full h-full flex items-center justify-center bg-gray-100",children:(0,o.jsxs)("div",{className:"text-center max-w-md p-8 bg-white rounded-lg shadow",children:[(0,o.jsx)("div",{className:"text-red-600 text-xl font-bold mb-4",children:"⚠️ Error Loading Map"}),(0,o.jsx)("p",{className:"text-gray-600",children:E})]})}):(0,o.jsxs)("div",{className:"absolute inset-0",children:[(0,o.jsx)("div",{ref:m,className:"w-full h-full"}),z&&!E&&(0,o.jsxs)("div",{className:"absolute top-4 right-4 z-20 max-w-[520px] bg-yellow-50 border border-yellow-200 text-yellow-900 rounded-lg shadow p-3",children:[(0,o.jsx)("div",{className:"text-sm font-semibold",children:"Map warning"}),(0,o.jsx)("div",{className:"text-xs mt-1 break-words",children:z})]}),T&&(0,o.jsx)("div",{className:"absolute inset-0 flex items-center justify-center bg-gray-100",children:(0,o.jsxs)("div",{className:"text-center",children:[(0,o.jsx)("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-calgary-blue mx-auto mb-4"}),(0,o.jsx)("p",{className:"text-gray-600 font-medium",children:"Loading Optimized Map..."}),(0,o.jsx)("p",{className:"text-gray-500 text-sm mt-2",children:"Fetching 21k+ properties"})]})})]})}},4982:function(){}}]);